# Substrate Node Templateå­¦ä¹ ç¬”è®°

## å¯èƒ½æœ‰ç”¨çš„èµ„æºé“¾æ¥

- [CLI Toolsä¸­å¯¹Substrate Node Templateçš„æè¿°](https://docs.substrate.io/reference/command-line-tools/node-template/)
- [Explore the code](https://docs.substrate.io/quick-start/explore-the-code/)
- [Substrateæœ¯è¯­è§£é‡Šè¡¨](https://docs.substrate.io/reference/glossary)
- [æ˜é‡‘ - Substrateä¸“æ ](https://juejin.cn/column/7227098017555005500)

## é˜…è¯»`cargo metadata`çš„è¾“å‡º

è¯¥æŒ‡ä»¤çš„è¾“å‡ºæ ¼å¼ä¸ºJSONæ ¼å¼ï¼Œæ•´ä½“è¿˜æ˜¯è¾ƒä¸ºæ¸…æ™°çš„ã€‚åªä¸è¿‡å…¶ä¸­çš„`resolve`å­—æ®µï¼Œæ¯”è¾ƒä¸å¥½ç†è§£ï¼Œç°ç»“åˆCargoæ‰‹å†Œè¿›è¡Œè¯´æ˜ã€‚

`resolve`å­—æ®µä¸‹è®¾`nodes`å’Œ`root`ä¸¤ä¸ªå­—æ®µã€‚åè€…æ˜¯æ ¹crateï¼Œä½†ä¸ä¸€å®šæœ‰å€¼ï¼Œå¯èƒ½æ˜¯`null`ï¼›å‰è€…æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ ‡è¯†ä¾èµ–å›¾ï¼ˆDependency Graphï¼‰ä¸­çš„èŠ‚ç‚¹ï¼Œå…¶ä¸­åŒ…å«è®¸å¤šå½¢ä¼¼å¦‚ä¸‹çš„ä»£ç ç‰‡æ®µï¼š

```json
{
    // è¿™idç¡®å®èƒ½å”¯ä¸€æ ‡è¯†ä¸€ä¸ªä¾èµ–é¡¹
    "id": "registry+https://github.com/rust-lang/crates.io-index#aead@0.4.3",
    // å½“å‰èŠ‚ç‚¹æ‰€æœ‰ä¾èµ–é¡¹çš„id
    "dependencies": [
        "registry+https://github.com/rust-lang/crates.io-index#generic-array@0.14.7",
        "registry+https://github.com/rust-lang/crates.io-index#rand_core@0.6.4"
    ],
    // å½“å‰èŠ‚ç‚¹ä¾èµ–é¡¹çš„å…·ä½“ä¿¡æ¯ï¼Œå’Œä¸Šè¾¹çš„"dependencies"çš„å†…å®¹ä¸€ä¸€å¯¹åº”
    "deps": [
        {
            // è€ƒè™‘åˆ°Cargo.tomlä¸­å¯ä»¥ç»™crateæ”¹åˆ«åï¼Œ
            // å› æ­¤è¿™å„¿çš„nameæœ‰å¯èƒ½æ˜¯åˆ«å
            "name": "generic_array",
            // ä¾èµ–é¡¹çš„id
            "pkg": "registry+https://github.com/rust-lang/crates.io-index#generic-array@0.14.7",
            "dep_kinds": [
                {
                    // ä¾èµ–é¡¹çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯
                    // "normal"ï¼ˆè¡¨ç°ä¸ºnullï¼‰ã€"build"ã€"dev"ç­‰
                    "kind": null,
                    // ä¾èµ–é¡¹çš„ç›®æ ‡å¹³å°ï¼Œå¯ä»¥æ˜¯
                    // nullï¼ˆè¡¨ç°ä¸ºnullï¼‰ã€"cfg(windows)"ç­‰
                    "target": null
                }
            ]
        },
        {
            "name": "rand_core",
            "pkg": "registry+https://github.com/rust-lang/crates.io-index#rand_core@0.6.4",
            // å…¶ä½™å†…å®¹å’Œä¸Šä¸€é¡¹ç±»ä¼¼
            // -- snip --
        }
    ],
    // å½“å‰èŠ‚ç‚¹å·²ç»å¯ç”¨çš„featureåˆ—è¡¨
    "features": [
        "alloc",
        "rand_core",
        "std"
    ]
}
```

## Substrate Node TemplateåŠå…¶å¤§è‡´åˆ’åˆ†

[Explore the code](https://docs.substrate.io/quick-start/explore-the-code/)ç« èŠ‚å¯¹Substrate Node Templateï¼ˆä¸‹ç®€ç§°SNTï¼‰çš„ä»£ç ç»“æ„ä½œäº†æ¦‚è¦æ€§é™ˆè¿°ï¼Œç¿»è¯‘å¦‚ä¸‹ï¼š

> **å…³äºSNT**
>
> SNTå›Šæ‹¬äº†ä¸€äº›é»˜è®¤çš„åŒºå—é“¾è¦ç´ æ„ä»¶ï¼Œä¾‹å¦‚p2pç½‘ç»œã€ç®€æ˜“å…±è¯†æœºåˆ¶ã€äº¤æ˜“å¤„ç†ç­‰ã€‚é’ˆå¯¹è´¦å·ã€ä½™é¢ã€äº¤æ˜“æ‰‹ç»­è´¹ã€ç®¡ç†å‘˜æƒé™ç­‰åŠŸèƒ½ï¼ŒSNTä¹Ÿæä¾›äº†ä¸€äº›åŸºç¡€çš„åŠŸèƒ½æ”¯æŒã€‚
>
> è¿™äº›æ ¸å¿ƒåŠŸèƒ½çš„å®ç°ï¼Œæ˜¯é€šè¿‡é¢„å…ˆå®šä¹‰å¥½çš„**pallets**æ¨¡å—æ¥å®ç°çš„ï¼Œä¾‹å¦‚ä»¥ä¸‹å‡ ä¸ªæ¨¡å—ï¼š
> - `pallet_balances`ï¼šç®¡ç†è´¦æˆ·èµ„äº§å’Œè´¦æˆ·ä¹‹é—´çš„è½¬è´¦ã€‚
> - `pallet_transaction_payment`ï¼šç®¡ç†äº¤æ˜“æ‰‹ç»­è´¹çš„å¤„ç†ã€‚
> - `pallet_sudo`ï¼šæ‰§è¡Œéœ€è¦ç®¡ç†å‘˜æƒé™çš„æ“ä½œã€‚
>
> SNTä¹Ÿæä¾›äº†ä¸€ä¸ªæ¨¡æ¿palletâ€”â€”`pallet_template`ï¼Œç”¨ä»¥å±•ç¤ºå¦‚ä½•å®ç°è‡ªå®šä¹‰palletçš„åŠŸèƒ½ã€‚
>
> æœ‰äº†ä¸Šè¿°çš„äº†è§£åï¼Œæˆ‘ä»¬å¯ä»¥æ›´åŠ æ·±å…¥åœ°æ¢ç´¢SNTçš„ä»£ç ï¼Œçœ‹çœ‹`substrate-node-template`é‡Œéƒ½æœ‰äº›å•¥ã€‚
>
> **æ¸…å•æ–‡ä»¶**
>
> SubstrateåŸºäºRustç¼–å†™ï¼Œå› æ­¤æ¯ä¸ªRusté¡¹ç›®éƒ½ä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„`Cargo.toml`æ–‡ä»¶ï¼ŒæŒ‡å¯¼è¯¥é¡¹ç›®çš„ç¼–è¯‘è¿‡ç¨‹ã€‚åœ¨`substrate-node-template`ç›®å½•ä¸‹çš„`Cargo.toml`ï¼Œè®°å½•ç€æ„æˆSNT å·¥ä½œç©ºé—´ï¼ˆworkspaceï¼‰çš„å‡ ä¸ªæˆå‘˜ï¼ˆmemberï¼‰é¡¹ç›®ï¼Œåƒè¿™æ ·ï¼š
>
> ```toml
> [workspace]
> members = [
>     "node",
>     "pallets/template",
>     "runtime",
> ]
> [profile.release]
> panic = "unwind"
> ```
>
> è¿™ä¹ˆçœ‹æ¥ï¼ŒSNTæ˜¯ç”±ä¸‰ä¸ªæˆå‘˜ç»„æˆçš„ï¼š
> - `node`ï¼šæä¾›Rustæ¨¡å—å®ç°äº†å¾ˆå¤šæ ¸å¿ƒåŒºå—é“¾æœåŠ¡ï¼Œä¾‹å¦‚p2pç½‘ç»œã€åŒºå—äº§ç”Ÿã€åŒºå—ç¡®è®¤ï¼ˆfinalizationï¼‰ã€äº¤æ˜“æ± ç®¡ç†ç­‰ã€‚
> - `pallets/template`ï¼šæä¾›äº†æ¨¡æ¿palletâ€”â€”`pallet_template`ï¼Œç”¨ä»¥å±•ç¤ºå¦‚ä½•å®ç°è‡ªå®šä¹‰palletçš„åŠŸèƒ½ã€‚
> - `runtime`ï¼šæä¾›åŒºå—é“¾åº”ç”¨é€»è¾‘ï¼ŒåŒ…æ‹¬è´¦å·ã€ä½™é¢ã€äº¤æ˜“æ‰‹ç»­è´¹ç­‰åŠŸèƒ½çš„å®ç°ã€‚
>
> æ¯ä¸ªæˆå‘˜é¡¹ç›®ä¹Ÿæœ‰å„è‡ªçš„`Cargo.toml`æ¸…å•æ–‡ä»¶ï¼Œå†…å«ç¼–è¯‘å„æˆå‘˜æ‰€éœ€çš„ä¾èµ–é¡¹ã€è®¾å®šç­‰ä¿¡æ¯ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ`node`é¡¹ç›®çš„`Cargo.toml`æ–‡ä»¶æŒ‡å®šäº†è¯¥æˆå‘˜çš„åå­—å«"node-template"ï¼Œå¹¶ä¸”åˆ—å‡ºäº†ä¸€äº›æ ¸å¿ƒåº“å’ŒåŸè¯­ï¼Œä»¥æä¾›åŒºå—é“¾èŠ‚ç‚¹æ¨¡æ¿æä¾›åŸºæœ¬åŒºå—é“¾æœåŠ¡æ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½ã€‚å…³äºåº“å’ŒåŸè¯­ï¼Œåœ¨[æ¶æ„ä¸ruståº“](https://docs.substrate.io/learn/architecture/)ä¸­æœ‰æ›´è¯¦ç»†çš„æè¿°ã€‚
>
> å½“ä¸‹ï¼Œåªéœ€æ˜ç™½æ¸…å•æ–‡ä»¶è®°å½•ç€å¾ˆå¤šé‡è¦ä¿¡æ¯ï¼Œå°±è¶³å¤Ÿäº†ã€‚
>
> å¦‚æœå»çœ‹`runtime/Cargo.toml`å’Œ`pallets/template/Cargo.toml`çš„è¯ï¼Œä¼šå‘ç°ä»–ä»¬ä¾èµ–çš„åº“å’ŒåŸè¯­ä¸å°½ç›¸åŒï¼Œä½†æ˜¯å¯¹å„è‡ªä¾èµ–äº›å•¥ä¼šæœ‰ç‚¹äº†è§£ã€‚
>
> **æ ¸å¿ƒå®¢æˆ·ç«¯æºç **
>
> SubstrateåŒºå—é“¾çš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯ï¼ŒèŠ‚ç‚¹ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šæ ¸å¿ƒå®¢æˆ·ç«¯å’Œè¿è¡Œæ—¶ã€‚SNTä¹Ÿä¸ä¾‹å¤–ï¼Œå…¶æä¾›æ ¸å¿ƒå®¢æˆ·ç«¯æœåŠ¡çš„rusté¡¹ç›®ä½äº`node/src`ç›®å½•ï¼Œè€Œè¿è¡Œæ—¶å®ç°ä½äº`runtime/src`ç›®å½•ã€‚
>
> é»˜è®¤æƒ…å†µä¸‹ï¼Œ`node/src`ç›®å½•åŒ…å«ä»¥ä¸‹Rustæ¨¡å—ï¼š
>
> - `benchmarking.rs`
> - `chain_spec.rs`
> - `cli.rs`
> - `command.rs`
> - `lib.rs`
> - `main.rs`
> - `rpc.rs`
> - `service.rs`
>
> å¤§éƒ¨åˆ†æ ¸å¿ƒå®¢æˆ·ç«¯æœåŠ¡é€»è¾‘éƒ½ä½äº`service.rs`æ¨¡å—ä¸­ã€‚è¿™äº›ä»£ç åœ¨å¼€å‘æ—¶å‡ ä¹ä¸éœ€è¦æ›´æ”¹ã€‚
>
> åœ¨å¼€å‘æ—¶æœ€æœ‰å¯èƒ½éœ€è¦ä¿®æ”¹çš„æ˜¯`chain_spec.rs`æ–‡ä»¶ï¼Œå®ƒæè¿°äº†é»˜è®¤å¼€å‘å’Œæœ¬åœ°æµ‹è¯•ç½‘ç»œçš„é…ç½®ï¼ŒåŒ…æ‹¬é»˜è®¤é¢„å……å€¼çš„å¼€å‘ç”¨è´¦æˆ·ï¼Œå’Œé¢„ç½®çš„æœ‰ç”Ÿäº§åŒºå—æƒé™çš„èŠ‚ç‚¹ã€‚å¦‚æœå¼€å‘è€…æƒ³åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„é“¾ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿®æ”¹`chain_spec.rs`æ–‡ä»¶ï¼Œä»¥æŒ‡å®šè¯¥é“¾æ‰€è¿æ¥åˆ°çš„ç½‘ç»œï¼Œä»¥åŠä¸ä¹‹é€šä¿¡çš„å…¶ä»–èŠ‚ç‚¹ã€‚
>
> **SNTé»˜è®¤è¿è¡Œæ—¶**
>
> é‰´äºSubstrateçš„æ¨¡å—æ€§å’Œçµæ´»æ€§ï¼Œä½ å¯ä»¥ä»»æ„ä¿®æ”¹å·¥ä½œç©ºé—´ä¸­çš„ä»»æ„ä¸€ä¸ªRusté¡¹ã€‚ä½†æ˜¯ï¼Œå¤§éƒ¨åˆ†åº”ç”¨å¼€å‘å·¥ä½œéƒ½åœ¨è¿è¡Œæ—¶å’Œpalletä¸­è¿›è¡Œã€‚åœ¨å¼€å§‹è‡ªå®šä¹‰è¿è¡Œæ—¶ä¹‹å‰ï¼Œä½ åº”è¯¥èŠ±ç‚¹æ—¶é—´æ¢ç´¢ä¸€ä¸‹SNTé»˜è®¤çš„è¿è¡Œæ—¶ã€‚
>
> é»˜è®¤è¿è¡Œæ—¶çš„æ¸…å•æ–‡ä»¶`Cargo.toml`ä¸­è®°å½•äº†è®¸å¤šåå­—ç±»ä¼¼äº`pallet-balances`, `pallet-sudo`è¿™æ ·çš„ä¾èµ–é¡¹ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¹Ÿæœ‰äº›åå­—ç±»ä¼¼`frame-xxx`çš„æ ¸å¿ƒä¾èµ–é¡¹ï¼Œä¾‹å¦‚`frame-system`, `frame-support`, `frame-executive`ç­‰ã€‚å…³äºè¿™äº›[æ ¸å¿ƒä¾èµ–é¡¹](https://docs.substrate.io/learn/runtime-development/#core-frame-services)ï¼Œç›®å‰åªéœ€çŸ¥é“å®ƒä»¬æ˜¯å¿…è¦çš„å°±è¡Œäº†ï¼Œä¸ç”¨å¤ªè¿‡åœ¨æ„ã€‚
>
> é»˜è®¤è¿è¡Œæ—¶çš„æºä»£ç æ”¾åœ¨`runtime/src/lib.rs`æ–‡ä»¶ä¸­ã€‚æ‰“å¼€ä¸€çœ‹å¥½å¤æ‚ï¼Œå…¶å®æœ¬è´¨å°±è¿™æ ·ï¼š
>
> - importäº†`frame_system`å’Œ`frame_support`æ ¸å¿ƒä¾èµ–é¡¹ã€‚
> - æŒ‡å®šäº†è¿è¡Œæ—¶çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚
> - å£°æ˜äº†è¦åŒ…å«çš„palletã€‚
> - å£°æ˜äº†æ¯ä¸ªpalletçš„ç±»å‹å’Œå‚æ•°ã€‚
> - è®¾ç½®äº†æ¯ä¸ªpalletçš„å¸¸é‡å’Œå˜é‡å€¼ã€‚
> - ä¸ºæ¯ä¸ªpalletå®ç°äº†`Config` traitã€‚
> - ç”¨è¿™äº›palletæ„é€ å‡ºäº†è¿è¡Œæ—¶ã€‚
> - ä¸ºè¯„ä¼°palletæ€§èƒ½è€Œå‡†å¤‡äº†benchmarkingæ¡†æ¶ã€‚
> - å®ç°äº†ä¾›æ ¸å¿ƒå®¢æˆ·ç«¯è°ƒç”¨è¿è¡Œæ—¶çš„æ¥å£ã€‚
>
> åœ¨[æ„é€ ](https://docs.substrate.io/build/)å’Œ[æµ‹è¯•](https://docs.substrate.io/test/)ä¸­æœ‰æ›´å¤šå…³äºè¿è¡Œæ—¶çš„æ„å»ºã€å®šä¹‰åŸºå‡†æµ‹è¯•ã€ä½¿ç”¨è¿è¡Œæ—¶çš„æ¥å£ç­‰è¯é¢˜çš„çŸ¥è¯†ã€‚ç°åœ¨å¯¹è¿™äº›å†…å®¹æœ‰ä¸ªå¤§æ¦‚äº†è§£å°±æˆã€‚

ç”±äºSNTçš„ä¾èµ–é¡¹éå¸¸å¤šä¸”åŠŸèƒ½å¤æ‚ï¼Œå¼€å‘å›¢é˜Ÿä½¿ç”¨äº†ä¸€ç§ç‰¹æ®Šçš„å‘½åæ–¹æ³•æ¥åŒºåˆ«ä¸åŒä¾èµ–é¡¹çš„ä½œç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€è¿°ï¼š

![Naming Schema](./note.assets/libraries.png)

å¯ä»¥çœ‹åˆ°ä¸Šå›¾ä¸­ä¾ç…§ä¾èµ–é¡¹çš„ç”¨é€”ï¼Œå°†ä¾èµ–é¡¹çš„å‰ç¼€åˆ’åˆ†ä¸ºä¸‰ç§ï¼š

- èŠ‚ç‚¹å¤–æœåŠ¡ï¼šè´Ÿè´£å’Œå…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šä¿¡
  - `sc_*`
- WASMè¿è¡Œæ—¶
  - `frame_*`
  - `pallet_*`
- è´Ÿè´£èŠ‚ç‚¹å¤–æœåŠ¡ï¼ˆouter nodeï¼‰å’Œè¿è¡Œæ—¶çš„æ•°æ®é€šä¿¡
  - `sp_*`

## å¯¹SNTçš„åˆæ­¥ç†è§£

å…³äºSNTçš„ç»“æ„åˆ’åˆ†ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹[æ—§ç‰ˆä»“åº“](https://github.com/Endericedragon/substrate-node-template-copy?tab=readme-ov-file#template-structure)é‡Œçš„æè¿°ã€‚ç®€å•ç¿»è¯‘ä¸€ä¸‹ï¼š

> åƒè¿™æ ·çš„Substrateé¡¹ç›®é€šå¸¸éƒ½åŒ…å«è®¸å¤šç»„ä»¶ï¼Œå®ƒä»¬åˆ†å¸ƒåœ¨å„ä¸ªä¸åŒçš„ç›®å½•ä¸­ã€‚
>
> **Nodeç»„ä»¶**
>
> ä¸€ä¸ªåŒºå—é“¾èŠ‚ç‚¹ï¼Œå°±æ˜¯ä¸€ä¸ªå…è®¸ç”¨æˆ·å‚ä¸åˆ°ä¸€ä¸ªåŒºå—é“¾ç½‘ç»œä¸­çš„åº”ç”¨ç¨‹åºã€‚åŸºäºSubstrateå¼€å‘çš„åŒºå—é“¾èŠ‚ç‚¹ï¼Œæä¾›äº†è®¸å¤šåŠŸèƒ½ï¼š
>
> - ç½‘ç»œï¼šSubstrateèŠ‚ç‚¹ä½¿ç”¨[libp2p](https://libp2p.io)ç½‘ç»œåè®®æ ˆï¼ˆè¯‘è€…æ³¨ï¼šè¿™ä¸ªåè®®æ ˆæœ‰å®˜æ–¹è®¤å¯çš„[rustå®ç°](https://github.com/libp2p/rust-libp2p)ï¼‰ï¼Œå®ç°äº†åŒºå—é“¾ç½‘ç»œä¸­èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ã€‚
> - å…±è¯†ï¼š[å…±è¯†ç®—æ³•](https://docs.substrate.io/learn/consensus/)æ˜¯åŒºå—é“¾å¿…é¡»çš„ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šç½‘ç»œçš„çŠ¶æ€ã€‚Substrateå…è®¸å¼€å‘è€…æä¾›è‡ªå®šä¹‰çš„å…±è¯†å¼•æ“ï¼ŒåŒæ—¶ä¹Ÿå†…ç½®äº†å¤šä¸ªåŸºäºWeb3åŸºé‡‘ä¼šç ”ç©¶çš„å…±è¯†æœºåˆ¶ã€‚
> - RPCæœåŠ¡å™¨ï¼šç”¨äºä¸SubstrateèŠ‚ç‚¹è¿›è¡Œäº¤äº’çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æœåŠ¡å™¨ã€‚
>
> `node`ç›®å½•ä¸­æœ‰è®¸å¤šæ–‡ä»¶ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå€¼å¾—ç‰¹åˆ«ç•™æ„ï¼š
>
> - `chain_spec.rs`ï¼šè§„å®šäº†Substrateé“¾çš„åˆå§‹çŠ¶æ€ï¼ˆåˆ›ä¸–çŠ¶æ€genesis stateï¼‰ã€‚è¿™ç©æ„åœ¨å¼€å‘å’Œæµ‹è¯•çš„æ—¶å€™å¾ˆå¥½ä½¿ï¼Œè€Œä¸”åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¹Ÿå¾ˆé‡è¦ã€‚å…¶ä¸­çš„`development_config`å’Œ`testnet_genesis`å‡½æ•°ç‰¹åˆ«é‡è¦ï¼Œå®ƒä»¬å®šä¹‰äº†æœ¬åœ°å¼€å‘é“¾çš„åˆ›ä¸–çŠ¶æ€ã€‚è¿™äº›å‡½æ•°å®šä¹‰äº†ä¸€äº›çŸ¥åè´¦æˆ·ï¼ˆä¾‹å¦‚Aliceå’ŒBobï¼‰ï¼Œå¹¶å°†å®ƒä»¬ç”¨äºé…ç½®åŒºå—é“¾çš„åˆå§‹çŠ¶æ€ã€‚
> - `service.rs`ï¼šå®šä¹‰äº†SubstrateèŠ‚ç‚¹çš„å®ç°ã€‚å…¶ä¸­çš„åº“å¼•ç”¨å’Œå‡½æ•°è°ƒç”¨éƒ½å€¼å¾—å…³æ³¨ã€‚æ¶‰åŠå…±è¯†ç›¸å…³çš„éƒ¨åˆ†å°¤å…¶å€¼å¾—å…³æ³¨ï¼Œä¾‹å¦‚åŒºå—æœ€ç»ˆå°è£…ç¡®å®šï¼ˆfinalizationï¼‰å’Œåˆ†å‰ç­‰ï¼Œè¿˜æœ‰å…¶ä»–å…±è¯†æœºåˆ¶ï¼Œä¾‹å¦‚Auraç”¨äºåŒºå—äº§ç”Ÿï¼ŒGRANDPAç”¨äºåŒºå—å°è£…ç¡®å®šã€‚
>
> **Runtimeç»„ä»¶**
>
> åœ¨Substrateçš„è¯­å¢ƒä¸­ï¼Œè¿è¡Œæ—¶ï¼ˆruntimeï¼‰å’ŒçŠ¶æ€è½¬ç§»å‡½æ•°ï¼ˆstate transition functionï¼‰éå¸¸ç±»ä¼¼ã€‚ä¸¤è€…éƒ½æŒ‡ä»£åŒºå—é“¾çš„æ ¸å¿ƒé€»è¾‘ï¼Œè´Ÿè´£éªŒè¯åŒºå—å’Œæ‰§è¡ŒçŠ¶æ€å˜æ›´ã€‚Substrateé¡¹ç›®åœ¨æœ¬ä»“åº“ä¸­ä½¿ç”¨[FRAME](https://docs.substrate.io/learn/runtime-development/#frame)æ„å»ºäº†åŒºå—é“¾è¿è¡Œæ—¶ã€‚FRAMEå…è®¸è¿è¡Œæ—¶å¼€å‘è€…å£°æ˜ç‰¹å®šé¢†åŸŸçš„é€»è¾‘ï¼Œç§°ä¸ºâ€œpalletâ€ï¼Œå¹¶å°†å…¶ç»Ÿç»Ÿç»„åˆæˆä¸€ä¸ªè¿è¡Œæ—¶ï¼Œä»¥æ»¡è¶³å„ç§éœ€æ±‚ã€‚
>
> åœ¨é˜…è¯»`src/runtime/lib.rs`æ—¶ï¼Œæ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š
> - è¯¥æºä»£ç æ–‡ä»¶ä¸ºè¿è¡Œæ—¶åŠ å…¥äº†å¥½å‡ ä¸ªpalletã€‚æ¯ä¸ªpalletçš„é…ç½®éƒ½å®šä¹‰åœ¨ä¸€ä¸ª`impl $PALLETåå­—::Config for Runtime`ä»£ç å—ä¸­ã€‚
> - è¿™äº›palleté€šè¿‡`construct_runtime!`å®ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆäº†ä¸€ä¸ªå¤§çš„è¿è¡Œæ—¶ã€‚å®ƒæ˜¯FRAMEçš„æ ¸å¿ƒåº“çš„ä¸€éƒ¨åˆ†ã€‚
>
> **Palletsç»„ä»¶**
>
> è¯¥Substrateé¡¹ç›®çš„è¿è¡Œæ—¶é™¤äº†ç”±ä¸€å¤§å †éšåŒSubstrateä»£ç ä»“åº“ä¸€åŒå‘å¸ƒçš„FRAME palletç»„æˆï¼Œè¿˜å¦æœ‰ä¸€ä¸ªæ¨¡æ¿palletï¼Œä½äº`pallets`ç›®å½•ä¸­ã€‚
>
> FRAME palletç”±ä¸€å¤§å †åŒºå—é“¾åŸºæœ¬æ„ä»¶ï¼ˆprimitivesï¼‰ç»„æˆï¼Œè¿™å…¶ä¸­åŒ…æ‹¬ï¼š
> - å­˜å‚¨ï¼šFRAMEå®šä¹‰äº†ä¸€ç³»åˆ—å¼ºå¤§çš„å­˜å‚¨æŠ½è±¡ï¼Œä½¿å¾—Substrateçš„é«˜æ•ˆçš„é”®å€¼æ•°æ®åº“å¯ä»¥è½»æ¾åœ°ç®¡ç†åŒºå—é“¾çš„æ¼”è¿›çŠ¶æ€ã€‚
> - åˆ†æ´¾å‡½æ•°ï¼šFRAME palletå®šä¹‰äº†ä¸€äº›ç‰¹æ®Šç±»å‹çš„å‡½æ•°ï¼Œå¯ä»¥ä»è¿è¡Œæ—¶ä¹‹å¤–çš„å¤–éƒ¨ç¯å¢ƒè°ƒç”¨ï¼ˆdispatchï¼‰æ¥æ›´æ–°å…¶çŠ¶æ€ã€‚
> - äº‹ä»¶ï¼šSubstrateä½¿ç”¨äº‹ä»¶æ¥é€šçŸ¥ç”¨æˆ·å‘ç”Ÿäº†é‡å¤§çŠ¶æ€å˜åŒ–ã€‚
> - é”™è¯¯ï¼šå½“åˆ†æ´¾å‡½æ•°å¤±è´¥æ—¶ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚
>
> æ¯ä¸ªpalletéƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„`Config` traitï¼Œå®ƒä½œä¸ºé€šç”¨æ¥å£ï¼Œå¯ä»¥é€šç”¨åœ°å®šä¹‰å®ƒæ‰€éœ€çš„æ•°æ®ç±»å‹å’Œå‚æ•°ã€‚

è¿™æ ·ä¸€æ¥å°±æŒ‡å‡ºäº†ä¸€æ¡ç ”ç©¶æ–¹å‘ï¼šSubstrateä¾èµ–çš„libp2pç½‘ç»œåè®®æ ˆï¼Œä»¥åŠFRAMEè¿è¡Œæ—¶å’Œpalletçš„æ¶æ„ã€‚å¦‚æœèƒ½æŠŠlibp2pç»™æ•´åˆ°rCoreä¸Šï¼Œé‚£å°±èƒ½ä¸ºå®ç°çœŸæ­£çš„åŒºå—é“¾æ“ä½œç³»ç»Ÿæ‰“ä¸‹å¾ˆå¥½çš„åŸºç¡€äº†ã€‚

## åˆæ¢Nodeç»„ä»¶

å…¶å®`node`ç›®å½•åº•ä¸‹çš„ä¸œè¥¿ä¸æ˜¯å¾ˆå¤æ‚ï¼Œæ‰8ä¸ªæ–‡ä»¶ï¼Œä¸€è·¯çœ‹è¿‡å»ä¹Ÿåº”è¯¥æœ‰ä¸ªäº†è§£äº†ã€‚ä»ä¸Šæ–‡ä¸­æˆ‘ä»¬å¾—çŸ¥è¿™ä¸ªNodeç»„ä»¶ä¸»è¦å¹²ä¸‰ä»¶äº‹ï¼šç½‘ç»œã€å…±è¯†ã€RPCã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ®æ­¤è¿›è¡Œæ¨¡å—åˆ’åˆ†ï¼ŒæŠŠNodeç»„ä»¶æ‹†æˆæ›´å°çš„ä¸‰ä¸ªå­æ¨¡å—ã€‚å¯¹`node`ç›®å½•æ‰§è¡Œ`cargo metadata`çœ‹çœ‹ï¼Ÿ

ç»“æœå‘ç°å’Œå¯¹SNTæ ¹ç›®å½•æ‰§è¡Œ`cargo metadata`æ²¡å•¥å·®åˆ«ã€‚ä½†æ˜¯å¥½æ­¹`resolve`çš„`root`æœ‰ä¸œè¥¿äº†ï¼Œæ˜¯`path+file:///home/endericedragon/repos/substrate-node-template-copy/node#node-template@4.0.0-dev`ã€‚

åœ¨`packages`å­—æ®µä¸­æœç´¢`node-template`ï¼Œæ‰¾åˆ°äº†`node`åŒ…ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…³äºå®ƒçš„åŸºæœ¬ä¿¡æ¯ï¼š

```json
{
    "name": "node-template",
    "version": "4.0.0-dev",
    "id": "path+file:///home/endericedragon/repos/substrate-node-template-copy/node#node-template@4.0.0-dev",
    "license": "MIT-0",
    "license_file": null,
    "description": "A fresh FRAME-based Substrate node, ready for hacking.",
    "source": null,
    "dependencies": [...],
    "targets": [
        {
            "kind": [
                "lib"
            ],
            "crate_types": [
                "lib"
            ],
            "name": "node-template",
            "src_path": "/home/endericedragon/repos/substrate-node-template-copy/node/src/lib.rs",
            "edition": "2021",
            "doc": true,
            "doctest": true,
            "test": true
        },
        {
            "kind": [
                "bin"
            ],
            "crate_types": [
                "bin"
            ],
            "name": "node-template",
            "src_path": "/home/endericedragon/repos/substrate-node-template-copy/node/src/main.rs",
            "edition": "2021",
            "doc": true,
            "doctest": false,
            "test": true
        },
        {
            "kind": [
                "custom-build"
            ],
            "crate_types": [
                "bin"
            ],
            "name": "build-script-build",
            "src_path": "/home/endericedragon/repos/substrate-node-template-copy/node/build.rs",
            "edition": "2021",
            "doc": false,
            "doctest": false,
            "test": false
        }
    ],
    // -- snip --
}
```

æŒ‰ç…§æˆ‘ä»¬ä»è¾“å‡ºå€’æ¨è¾“å…¥çš„ä¸€è´¯ä½œé£ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹æŠŠSNTè¿è¡Œèµ·æ¥ä¼šçœ‹åˆ°å•¥ã€‚

ç¬¬ä¸€ä¸ªè¾“å‡ºæ ‡è®°äº†ç¬”è€…ä¹‹å‰å‘ç°çš„ç¨‹åºå…¥å£ç‚¹ï¼ˆç°å·²åˆ é™¤ï¼‰ï¼š

```rust
I guess the whole program starts from here!
```


è¿™ä¸ª`println!`ä½äº`node/src/main.rs`ä¸­ã€‚è·Ÿè¸ªå…¶è¿è¡Œè½¨è¿¹ï¼Œå¯çŸ¥å…¶ä¸‹ä¸€æ­¥ä¼šå‰å¾€è¿™ä¸ªå‡½æ•°ï¼š

```rs
// file: node/src/command.rs

pub fn run() -> sc_cli::Result<()> {
	// è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œå½¢æˆç»“æ„åŒ–çš„é…ç½®é€‰é¡¹
	let cli = Cli::from_args();

	match &cli.subcommand {
        // --snip --
		None => {
			// ./target/release/node-template --dev å°†ä¼šæ¥åˆ°è¿™ä¸ªåˆ†æ”¯
			let runner = cli.create_runner(&cli.run)?;
			runner.run_node_until_exit(|config| async move {
				service::new_full(config).map_err(sc_cli::Error::Service)
			})
		},
	}
}
```

ä¹‹æ‰€ä»¥æŠŠmatchçš„å…¶ä»–arméƒ½åˆ æ‰ï¼Œæ˜¯å› ä¸ºæ ¹æ®è°ƒè¯•ç»“æœï¼Œ`./target/release/node-template --dev`ç›´æ¥å°±æ…åˆ°æœ€åä¸€ä¸ªåˆ†æ”¯å»äº†ï¼Œå…¶ä»–åˆ†æ”¯ç›´æ¥å¿½è§†å³å¯ã€‚å…¶ä¸­çš„`run_node_until_exit`å€¼å¾—å…³æ³¨ï¼Œè¿™æ„å‘³ç€SNTè¿›å…¥äº†ä¸€ä¸ªæ°¸ä¸åœæ­¢çš„äº‹ä»¶å¾ªç¯ï¼ˆå®é™…ä¸Šä¹Ÿç¡®å®å¦‚æ­¤ï¼Œå› ä¸ºåªæœ‰æŒ‰Ctrl+Cæ‰èƒ½è®©SNTåœä¸‹æ¥ï¼‰ã€‚

è¿›å…¥è¿™ä¸ªå‡½æ•°ä¹‹åé¦–å…ˆä¼šæ‰“å°ä¸€å¤§å †ä¿¡æ¯ï¼š

```bash
2024-06-28 21:00:30 Substrate Node
2024-06-28 21:00:30 âœŒï¸  version 4.0.0-dev-65686f28d2e
2024-06-28 21:00:30 â¤ï¸  by Substrate DevHub <https://github.com/substrate-developer-hub>, 2017-2024
2024-06-28 21:00:30 ğŸ“‹ Chain specification: Development
2024-06-28 21:00:30 ğŸ·  Node name: exuberant-breath-4025
2024-06-28 21:00:30 ğŸ‘¤ Role: AUTHORITY
```

> è¿™é‡Œæœ‰ä¸ªå€¼å¾—å…³æ³¨çš„ç‚¹ï¼Œå³ï¼šå¾ˆå¤šæ–¹æ³•åœ¨è°ƒè¯•æ—¶ä¸ä¼šç«‹é©¬è¿”å›ï¼Œè€Œæ˜¯ä¼šæ„£ä¸€ä¼šï¼ˆé˜»å¡ä¸€æ®µæ—¶é—´ï¼‰å†è¿”å›ï¼Œè¿™æ˜¯å› ä¸ºè¿™äº›è€—æ—¶çš„ä»»åŠ¡éƒ½æ˜¯ä½¿ç”¨tokioçš„Runtimeçš„`block_on`æ–¹æ³•æ‰§è¡Œçš„ï¼Œè™½ç„¶æ˜¯åç¨‹æ‰§è¡Œä½†æ˜¯å´ç”¨é˜»å¡çš„åŠæ³•æ‰§è¡Œï¼Œå› æ­¤éœ€è¦ç­‰ä¸€ä¼šã€‚

ç¬¬ä¸€æ¬¡é˜»å¡å‘ç”Ÿåœ¨è¿™é‡Œï¼š

```rust
// file: ~/.cargo/git/checkouts/substrate-7e08433d4c370a21/948fbd2/client/cli/src/runner.rs
let mut task_manager = self.tokio_runtime.block_on(initialize(self.config))?;
```

è¿™æ®µç¨‹åºä¼šåœ¨æ§åˆ¶å°è¾“å‡ºï¼š

```bash
2024-06-30 16:04:19 ğŸ’¾ Database: RocksDb at /tmp/substrate1JC7cz/chains/dev/db/full
2024-06-30 16:04:47 ğŸ”¨ Initializing Genesis block/state (state: 0xf5e5â€¦55e2, header-hash: 0x8116â€¦d409)
2024-06-30 16:04:47 ğŸ‘´ Loading GRANDPA authority set from genesis on what appears to be first startup.
2024-06-30 16:04:48 Using default protocol ID "sup" because none is configured in the chain specs
2024-06-30 16:04:48 ğŸ·  Local node identity is: 12D3KooWL4N3swArnvrkRQXNTnv8JzsvMKnUX1h8jkdUPoUU21ey
```

å…¶ä¸­å‡ºç°çš„`initialize`æ˜¯`run_node_until_exit`å‡½æ•°çš„å”¯ä¸€ä¸€ä¸ªä¼ å…¥çš„å‚æ•°ï¼Œå…¶ç±»å‹ä¸º`impl FnOnce(Configuration) -> F`ã€‚æ¢è¨€ä¹‹ï¼Œä¸Šè¿°è¯­å¥ä»¤åœ¨tokioçš„runtimeä¸­æ‰§è¡Œäº†initializeé—­åŒ…ï¼Œåè€…è¿”å›äº†ä¸€ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œå­˜å‚¨äº`task_manager`ä¸­ã€‚å›çœ‹è°ƒç”¨`run_node_until_exit`çš„åœ°æ–¹ï¼Œå‘ç°SNTä¼ å…¥äº†ä¸€ä¸ªè¿™æ ·çš„é—­åŒ…ï¼š

```rs
|config| async move {
    service::new_full(config).map_err(sc_cli::Error::Service)
}
```

çœ‹æ¥æœ‰å¿…è¦è°ƒæŸ¥ä¸€ä¸‹`service`æ¨¡å—äº†ã€‚

æ¥ä¸‹æ¥çš„äº‹æƒ…å°±æœ‰è¶£äº†ï¼Œç¨‹åºè¿è¡Œåˆ°è¿™é‡Œï¼Œå°±å¼€å§‹ç©å‘½ç”Ÿäº§ & å°è£…åŒºå—äº†ï¼š

```rs
let res = self
    .tokio_runtime
    .block_on(self.signals.run_until_signal(task_manager.future().fuse()));
```

è¿™è¯´æ˜æŒ–çŸ¿çš„é€»è¾‘å°±åœ¨è¿™ä¸ª`self.signals.run_until_signal(task_manager.future().fuse())`é‡Œã€‚å› æ­¤ï¼Œè¿™é‡Œå‡ºç°çš„æ¯ä¸€ä¸ªå‡½æ•°éƒ½å€¼å¾—å¥½å¥½ç ”ç©¶ä¸€ç•ªã€‚

### chain_spec æ¨¡å—

Substrateæ–‡æ¡£ä¸­ç‰¹æ„æåŠï¼Œnodeç›®å½•ä¸­æœ‰å‡ ä¸ªæ–‡ä»¶éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œä¸€ä¸ªæ˜¯`chain_spec.rs`ï¼Œå¦ä¸€ä¸ªæ˜¯`service.rs`ã€‚æœ¬èŠ‚å°†è®¨è®ºå‰è€…ï¼Œä¸‹ä¸€èŠ‚è®¨è®ºåè€…ã€‚

**å¼•ç”¨åˆ†æ**

é¦–å…ˆä»`runtime`ä¸­å¼•ç”¨äº†ä¸€å¤§å †è¡¨å¾è´¦æˆ·ã€é…ç½®çš„structã€‚ç„¶åä»`sc_service`ä¸­å¼•å…¥äº†è¡¨å¾é“¾ç±»å‹çš„æšä¸¾`ChainType`ï¼š

```rs
pub enum ChainType {
    Development,
    Local,
    Live,
    Custom( /* â€¦ */ )
}
```

ä»ä¸Šæ–‡ä¸­çš„å™è¿°å¯çŸ¥ï¼Œä»¥`sc_*`å¼€å¤´çš„ä¾èµ–è´Ÿè´£å’Œå¤–éƒ¨å…¶ä»–èŠ‚ç‚¹é€šä¿¡ã€‚è¿™æ˜¯`chain_spec.rs`å”¯ä¸€ä¸€ä¸ªç”¨åˆ°`sc_*`çš„åœ°æ–¹ã€‚å…¶ä½™çš„ä¾èµ–é¡¹éƒ½æ˜¯ä»`sp_*`å¼•å…¥çš„ï¼Œå³è´Ÿè´£èŠ‚ç‚¹é€šä¿¡æ¨¡å—å’Œå†…éƒ¨runtimeæ¨¡å—æ•°æ®äº¤æ¢çš„ä¾èµ–é¡¹ã€‚

**ç§æœ‰è¾…åŠ©å‡½æ•°**

åªæœ‰ä¸€ä¸ªç§æœ‰çš„è¾…åŠ©å‡½æ•°ï¼š

```rust
fn testnet_genesis(
	wasm_binary: &[u8], // æ¥æºäºWASM_BINARY.ok_or_else(...)
	initial_authorities: Vec<(AuraId, GrandpaId)>, // ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«PoAå…±è¯†ç®—æ³•æ‰€éœ€è¦çš„åŒºå—ç”Ÿäº§è€…ï¼ˆauthorityï¼‰çš„Idå¯¹ï¼Œç”±åŒä¸€ä¸ªç§å­åœ¨AuraIdå’ŒGrandpaIdä¸­è®¡ç®—è·å¾—çš„ä¸¤ä¸ªå…¬é’¥æ„æˆã€‚
	root_key: AccountId, // æ ¹ç”¨æˆ·ï¼Œç®¡ç†å‘˜ï¼Œé€šå¸¸æ˜¯é€šè¿‡è°ƒç”¨get_account_id_from_seedä»ç»™å®šseedä¸­ç®—å‡ºæ¥çš„
	endowed_accounts: Vec<AccountId>, // æ‰€æœ‰é¢„å®šç”¨æˆ·çš„åˆ—è¡¨
	_enable_println: bool,
) -> RuntimeGenesisConfig
```

å…¶ä¸­ï¼Œ`WASM_BINARY`æ˜¯ä»`runtime`ä¸­å¼•å…¥çš„å¸¸é‡ï¼Œ`AuraId, GrandpaId, AccountId, RuntimeGenesisConfig`å‡ä¸ºä»`runtime`ä¸­å¼•å…¥çš„ç»“æ„ä½“ï¼Œä»–ä»¬çš„ä½œç”¨å°†ä¼šåœ¨åç»­çš„å…¬å¼€å‡½æ•°ä¸­è§£é‡Šã€‚ä¸è¿‡ï¼Œè”ç³»ä¸Šä¸‹æ–‡æ¥çœ‹ï¼Œå¯ä»¥ç»™å‡ºè¿™æ ·çš„è½¬æ¢å…³ç³»ï¼š

```mermaid
graph LR
seed[seed: &str] -->|AuraIdä¸­å®šä¹‰çš„ç®—æ³•| auraPub[AuraIdå…¬é’¥]
seed -->|GrandpaIdä¸­å®šä¹‰çš„ç®—æ³•| grandpaPub[GrandpaIdå…¬é’¥]
auraPub -->|ä½œä¸ºå…ƒç»„çš„ç¬¬1é¡¹| éªŒè¯è€…Id
grandpaPub -->|ä½œä¸ºå…ƒç»„çš„ç¬¬2é¡¹| éªŒè¯è€…Id
seed -->|sr25519::Publicä¸­å®šä¹‰çš„ç®—æ³•| AccoundId
```

ä¸Šè¿°å‡½æ•°æ„é€ ä¸€ä¸ªåˆ›ä¸–å—çš„é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­é¢„ç½®è´¦å·ä¸º`endowed_accounts`æ‰€æŒ‡å®šï¼ŒåŒºå—ç”Ÿäº§è€…ç”±`initial_authorities`æŒ‡å®šï¼Œè¶…çº§ç®¡ç†å‘˜ç”±`root_key`æŒ‡å®šã€‚

> æ³¨ï¼šåœ¨Substrateè¯­å¢ƒä¸‹ï¼Œå…±è¯†æ“ä½œåˆ†ä¸ºä¸¤æ­¥ï¼Œä¸€æ­¥å«Block Authoringï¼ˆèŠ‚ç‚¹ç”¨æ¥ç”Ÿäº§åŒºå—çš„æ–¹æ³•ï¼‰ï¼Œä¸€æ­¥å«Block Finalizationï¼ˆåœ¨é“¾å‡ºç°åˆ†æ”¯æ—¶ç¡®å®šé€‰æ‹©å“ªä¸ªåˆ†æ”¯çš„æ–¹æ³•ï¼‰ã€‚å› æ­¤å¯ä»¥æ¨æ–­ï¼Œä¸Šæ–‡ä»£ç ä¸­çš„`initial_authorities`å®é™…ä¸ŠæŒ‡çš„å°±æ˜¯ç”Ÿäº§åŒºå—çš„è´¦æˆ·ã€‚

**å…¬å¼€å‡½æ•°**

```rs
pub fn get_from_seed<TPublic: Public>(seed: &str) -> <TPublic::Pair as Pair>::Public
```

ä¸Šè¿°å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆå­—é¢é‡ï¼‰ä½œä¸ºç§å­ï¼Œç„¶åæŒ‰ç…§æ³›å‹å‚æ•°`TPublic`ä¸­å®šä¹‰çš„æ±‚å¯†é’¥å¯¹ï¼ˆä¸€å…¬ä¸€ç§ï¼‰ç®—æ³•æ±‚å¾—å…¬é’¥ã€‚

```rs
pub fn get_account_id_from_seed<TPublic: Public>(seed: &str) -> AccountId
where
	AccountPublic: From<<TPublic::Pair as Pair>::Public>,
```

ä¸Šè¿°å‡½æ•°ç»å†äº†æ•°æ¬¡è½¬æ¢ã€‚é¦–å…ˆï¼Œæ¥å—ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆå­—é¢é‡ï¼‰ä½œä¸ºç§å­ï¼Œç„¶åæŒ‰ç…§æ³›å‹å‚æ•°`TPublic`ä¸­å®šä¹‰çš„ç®—æ³•æ±‚å¾—å…¬é’¥ã€‚å–å¾—å…¬é’¥åï¼Œè½¬æ¢ä¸º`AccountPublic`ï¼Œå†è°ƒç”¨`into_account`æ–¹æ³•ï¼Œæœ€ç»ˆè·å¾—äº†`AccountId`ã€‚

```rs
pub fn authority_keys_from_seed(s: &str) -> (AuraId, GrandpaId) {
	(get_from_seed::<AuraId>(s), get_from_seed::<GrandpaId>(s))
}
```

ä¸Šè¿°å‡½æ•°ç»“æ„è¿‡äºç®€å•ï¼Œç›´æ¥æŠŠæºä»£ç ä¸¢è¿™å„¿ï¼Œå®é™…ä¸Šå°±æ˜¯ç”¨Auraå’ŒGRANDPAä¸¤ç§ç®—æ³•æŠŠåŒä¸€ä¸ªç§å­å„è‡ªç®—ä¸€éï¼Œç„¶åå¡è¿›ä¸€ä¸ªå…ƒç»„é‡Œå½¢æˆä¸€å¯¹å”¯ä¸€æ ‡è¯†ä¸€ä½åŒºå—ç”Ÿäº§è€…çš„â€œé”®â€ã€‚

```rs
pub fn development_config() -> Result<ChainSpec, String>
pub fn local_testnet_config() -> Result<ChainSpec, String>
```

è¿™ä¿©å¤ªåƒäº†ï¼Œæ”¾åœ¨ä¸€èµ·è®²ä¹Ÿæˆã€‚ä»–ä»¬çš„ä»»åŠ¡éƒ½æ˜¯ç±»ä¼¼çš„ï¼š

1. æ ¹æ®`WASM_BINARY`æ‰¾åˆ°WASMäºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ã€‚æ‰¾ä¸åˆ°å°±æŠ¥é”™ï¼Œé€€å‡ºã€‚
2. ä»¥`ChainSpec`çš„å½¢å¼ï¼Œè¿”å›ä¸€ä¸ªé“¾é…ç½®ã€‚
   1. å‰è€…çš„é“¾åä¸º`Development`ï¼Œidä¸º`dev`ï¼›åè€…çš„é“¾åä¸º`Local Testnet`ï¼Œidä¸º`local_testnet`ã€‚
   2. å‰è€…çš„é“¾ç±»å‹ä¸º`ChainType::Development`ï¼Œåè€…çš„æ˜¯`ChainType::Local`ã€‚
   3. å‰è€…çš„åŒºå—ç”Ÿäº§è€…åªæœ‰"Alice"ï¼Œåè€…æœ‰"Alice"å’Œ"Bob"ã€‚
   4. å‰è€…çš„é¢„ç½®è´¦å·åªæœ‰å››ä¸ªï¼Œåè€…æœ‰ä¸€å¤§å †ã€‚

å…¶ä½™é€‰é¡¹å‡ä¸ºç©ºï¼Œæ•…ä¸å†èµ˜è¿°ã€‚è¿™ä¿©å‡½æ•°ä¼šåœ¨`node/src/command.rs`çš„`impl SubstrateCli for Cli`ä¸­çš„`load_spec`æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚ä½†æ˜¯åè€…ä¼¼ä¹æ²¡åœ¨ä»»ä½•åœ°æ–¹è¢«è°ƒç”¨è¿‡ï¼Ÿï¼Ÿï¼Ÿå¯èƒ½è¿™ä¸ªè°ƒç”¨ä¸æ˜¯æ˜¾å¼çš„ï¼Œè€Œä¸”å…¶è°ƒç”¨ä½ç½®å¯èƒ½å‹æ ¹ä¸åœ¨SNTä¸­è€Œæ˜¯åœ¨SNTçš„ä¾èµ–ä¸­ï¼ˆæ¯•ç«Ÿæ˜¯ä¸ªtraitï¼‰ã€‚

### service æ¨¡å—

è¿™æ¨¡å—ä½¿ç”¨äº†ä¸¤ç§å…±è¯†ç®—æ³•ã€‚ä¸ºäº†æ›´å¥½åœ°åˆ†æä»£ç ï¼Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹è¿™ä¸¤ç§å…±è¯†ç®—æ³•ã€‚

> **Auraå…±è¯†ç®—æ³•ï¼šç”Ÿäº§åŒºå—**
>
> [Auraå…±è¯†ç®—æ³•](https://openethereum.github.io/Aura)ååˆ†å®¹æ˜“ç†è§£ã€‚å®ƒæ˜¯ç”¨æ¥ç¡®å®šç”±è°æ¥ç”Ÿäº§åŒºå—çš„ã€‚è¿™ä¸œè¥¿çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š
>
> 1. å°†è¿ç»­çš„æ—¶é—´åˆ’åˆ†ä¸ºç¦»æ•£çš„ä¸€ä¸ªä¸€ä¸ªæ—¶é—´ç‰‡ã€‚æ¯ä¸ªæ—¶é—´ç‰‡ä¸­ï¼Œåªæœ‰ä¸€éƒ¨åˆ†çš„åŒºå—ç”Ÿäº§è€…èƒ½äº§ç”Ÿæ–°çš„åŒºå—ã€‚
> 2. åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡ä¸­é€‰æ‹©ç”Ÿäº§è€…çš„åŠæ³•æ˜¯è½®æ¢ï¼š$é€‰ä¸­çš„ç”Ÿäº§è€…çš„ç¼–å· = \frac{å½“å‰æ—¶é—´æˆ³}{æ—¶é—´ç‰‡å¤§å°}\ \%\ ç”Ÿäº§è€…æ•°é‡$ã€‚
> 3. å¦æœ‰ä¸€ç§å«BABEçš„å…±è¯†ç®—æ³•ï¼Œå®ƒå’ŒAuraä¸€æ ·ä¹Ÿè´Ÿè´£åŒºå—ç”Ÿæˆï¼Œä½†å®ƒé€‰æ‹©ç”Ÿäº§è€…çš„åŠæ³•æ˜¯ä½¿ç”¨éšæœºæ•°éšæœºé€‰æ‹©ã€‚

> **Grandpaå…±è¯†ç®—æ³•ï¼šæ¶ˆé™¤åˆ†å‰**
>
> GRANDPAå…±è¯†ç®—æ³•ä¼¼ä¹æœ‰äº›å¤æ‚ï¼Œä»¥è‡³äºéœ€è¦ä¸€æ•´ç¯‡è®ºæ–‡æ¥è®ºè¿°å®ƒã€‚å¥½åœ¨[æ³¢å¡é“¾wiki](https://wiki.polkadot.network/docs/learn-consensus#finality-gadget-grandpa)ç®€è¦ä»‹ç»äº†ä¸€ä¸‹è¿™ä¸ªä¸œè¥¿ï¼Œå¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªè¿ä½œæ–¹æ³•ï¼š
>
> 1. é¦–å…ˆæŒ‡å®šä¸€ç»„èŠ‚ç‚¹ç”¨æ¥åšâ€œé€‰æ°‘â€ï¼ˆvoterï¼‰ï¼Œä»–ä»¬ä¼šç»™ä¸€æ®µé“¾ï¼ˆè€Œä¸æ˜¯å•ä¸ªçš„èŠ‚ç‚¹ï¼Œè¿™æ ·å¹²æœ‰åˆ©äºæé«˜æ•ˆç‡ï¼‰æŠ•ç¥¨ã€‚
> 2. ä¸€æ—¦æŸæ¡åˆ†å‰è·å¾—äº†$\frac{2}{3}$çš„ç¥¨æ•°ï¼Œå°±æŠŠå®ƒè®¤ä¸ºæ˜¯â€œæ­£ç»Ÿçš„â€ï¼Œç„¶åæŠŠå…¶ä»–åˆ†å‰éƒ½ä¸¢æ‰ã€‚
> 3. ä¼¼ä¹ä¸æ­¢ä¸€è½®æŠ•ç¥¨ï¼Œèµ·ç å¾—ç»è¿‡ä¸¤è½®ï¼ˆé¢„æŠ•ç¥¨pre-voteå’Œé¢„æäº¤pre-commitï¼‰ã€‚
>
> åœ¨Substrateä¸­å®ƒä»¥[frame palletçš„å½¢å¼](https://github.com/paritytech/polkadot-sdk/tree/master/substrate/frame/grandpa)å‡ºç°ã€‚

æœ‰äº†ä»¥ä¸Šçš„çŸ¥è¯†å‚¨å¤‡ï¼Œè®©æˆ‘ä»¬dive into service.rså§ã€‚

`service.rs`ä¸­ç›´æ¥è¢«å¤–ç•Œè°ƒç”¨çš„å°±æ˜¯å®ƒçš„`new_full`å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨æ­£å¸¸çŠ¶æ€ä¸‹è¿”å›ä¸€ä¸ª`Result<TaskManager, ...>`ï¼Œå› æ­¤é¦–å…ˆéœ€è¦çŸ¥é“è¿™ä¸ª`TaskManager`ä½•æ–¹ç¥åœ£ã€‚é€šè¿‡F12å¤§æ³•çŸ¥é“ã€‚ã€‚ã€‚è¿˜æ˜¯çœ‹ä¸æ‡‚ã€‚